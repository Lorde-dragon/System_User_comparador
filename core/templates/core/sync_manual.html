{% extends "core/base.html" %}
{% block title %}Atualizar Banco{% endblock %}
{% load static %}
{% block content %}

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .btn-gold {
    background-color: #c59d2f;
    color: #fff;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
  }
  .btn-gold:hover {
    background-color: #e0b84b;
    color: #000;
    transform: translateY(-2px);
  }
  .card-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.1);
  }
  .badge-status {
    font-size: 0.85rem;
  }
  .status-running {
    background-color: #007bff;
  }
  .status-success {
    background-color: #28a745;
  }
  .status-error {
    background-color: #dc3545;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-dark mb-0">
      <i class="bi bi-database-up text-warning me-2"></i>Atualizar Banco de Dados
    </h3>
    {% if user.is_staff or user.is_superuser %}
    <a href="{% url 'dashboard' %}" class="btn btn-dark fw-semibold">
      <i class="bi bi-arrow-left-circle me-1"></i> Voltar
    </a>
    {% endif %}
  </div>

  {% if user.is_staff or user.is_superuser %}
  <div class="card border-0 shadow-sm p-4 mb-4 bg-light">
    <h5 class="fw-semibold mb-3"><i class="bi bi-arrow-repeat text-warning me-2"></i>Executar Sincronização</h5>
    <form method="post" class="text-center">
      {% csrf_token %}
      <button type="submit" class="btn btn-gold px-4 py-2">
        <i class="bi bi-cloud-download me-2"></i>Atualizar banco agora
      </button>
    </form>
  </div>
  {% else %}
  <div class="alert alert-danger shadow-sm">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    Apenas administradores podem executar atualizações de banco.
  </div>
  {% endif %}

  {% if run %}
  <div class="alert alert-secondary shadow-sm mt-3">
    <i class="bi bi-clock-history text-warning me-2"></i>
    <strong>Última execução:</strong> {{ run.created_at|date:"d/m/Y H:i" }}
    —
    <span class="badge badge-status 
      {% if run.status == 'running' %}status-running{% elif run.status == 'success' %}status-success{% else %}status-error{% endif %}
      ">
      {{ run.status|upper }}
    </span>
    {% if run.mensagem %}
      <span class="ms-2 text-muted">({{ run.mensagem }})</span>
    {% endif %}
  </div>
  {% endif %}

  <div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between">
      <h6 class="mb-0"><i class="bi bi-list-check text-warning me-2"></i>Histórico de Execuções</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th>Fonte</th>
            <th class="text-end">Lidos</th>
            <th class="text-end">Gravados</th>
            <th class="text-end">Ignorados</th>
            <th>Mensagem de Erro</th>
          </tr>
        </thead>
        <tbody>
          {% for i in itens %}
          <tr>
            <td>{{ i.created_at|date:"d/m/Y H:i" }}</td>
            <td>{{ i.fonte }}</td>
            <td class="text-end">{{ i.lidos }}</td>
            <td class="text-end text-success fw-semibold">{{ i.gravados }}</td>
            <td class="text-end text-danger fw-semibold">{{ i.ignorados }}</td>
            <td>
              {% if i.mensagem_erro %}
                <span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>{{ i.mensagem_erro }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center text-muted py-3">Nenhuma execução registrada</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
