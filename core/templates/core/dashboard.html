{% extends "core/base.html" %}
{% load dictutils %}
{% block content %}
{% load static %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}JDash - UserCompare{% endblock %}</title>
    
    <!-- üî∏ Favicon -->
    <link rel="icon" type="image/png" href="{% static 'images/Icone.png' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/Icone.ico' %}">
    
    <!-- üî∏ CSS principal (Tailwind ou Bootstrap, se usar) -->
    {% block styles %}{% endblock %}


<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .card-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.1);
  }
  .pulse-green { animation: pulse-green 2s infinite; }
  .pulse-red { animation: pulse-red 2s infinite; }
  @keyframes pulse-green {
    0%, 100% { background-color: #02ff3d; }
    50% { background-color: #b2fdd4; }
  }
  @keyframes pulse-red {
    0%, 100% { background-color: #ff3c4fff; }
    50% { background-color: #ffbcbc; }
  }
</style>

<div class="container-fluid mt-1 animate__animated animate__fadeIn">

  <!-- Painel superior de a√ß√µes adm -->
  {% if user.is_staff or user.is_superuser %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <link icon rel="icon" type="image/png" href="{% static 'images/Icone.png' %}">
    <h3 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-line text-warning me-2"></i>Comparador</h3>

    <div class="d-flex gap-2">
      <a href="{% url 'sync_manual' %}" class="btn btn-warning text-dark fw-semibold">
        <i class="bi bi-arrow-repeat me-1"></i> Atualizar Dados
      </a>
      <a href="{% url 'admin:index' %}" class="btn btn-dark fw-semibold">
        <i class="bi bi-person-plus me-1"></i> Espa√ßo Adm
      </a>
    </div>
  </div>
  {% else %}
  <h3 class="fw-bold text-dark mb-4"><i class="bi bi-bar-chart-line text-warning me-2"></i>Comparador de Sistemas</h3>
  {% endif %}

  <!-- Filtros -->
  <div class="card shadow-sm border-0 p-4 mb-4 bg-light">
    <h4 class="fw-bold text-secondary mb-3"><i class="bi bi-funnel-fill text-warning me-2"></i>Filtros</h4>
    <form class="row g-3 align-items-end">
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Status</label>
        <select name="status" class="form-select">
          <option value="Ativo" {% if status_sel == 'Ativo' %}selected{% endif %}>Ativos</option>
          <option value="Inativo" {% if status_sel == 'Inativo' %}selected{% endif %}>Inativos</option>
          <option value="Todos" {% if status_sel not in 'Ativo Inativo' %}selected{% endif %}>Todos</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small fw-semibold">Departamento</label>
        <select name="departamento" class="form-select">
          <option value="">(todos)</option>
          {% for d in departamentos %}
            <option value="{{ d }}" {% if dept_sel == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small fw-semibold">Busca</label>
        <input name="q" value="{{ q }}" class="form-control" placeholder="nome, dom√≠nio, email...">
      </div>

      <div class="col-md-3">
        <label class="form-label small fw-semibold">Somente diverg√™ncias</label>
        <select name="div" class="form-select">
          <option value="">(n√£o)</option>
          <option value="ponto" {% if div_sel == 'ponto' %}selected{% endif %}>Ponto</option>
          <option value="gestta" {% if div_sel == 'gestta' %}selected{% endif %}>Gestta</option>
          <option value="dominio" {% if div_sel == 'dominio' %}selected{% endif %}>Dom√≠nio</option>
          <option value="web" {% if div_sel == 'web' %}selected{% endif %}>CControlWeb</option>
          <option value="visao" {% if div_sel == 'visao' %}selected{% endif %}>Vis√£o L√≥gica</option>
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-dark"><i class="bi bi-filter-circle me-1"></i>Filtrar</button>
      </div>
    </form>
  </div>

  <!-- Cards resumo -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
      <div class="card card-hover border-0 shadow-sm p-3 text-center">
        <div class="text-muted small">Diverg√™ncias Ponto</div>
        <div class="fs-4 fw-bold text-danger">{{ cont_div.ponto }}</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
      <div class="card card-hover border-0 shadow-sm p-3 text-center">
        <div class="text-muted small">Diverg√™ncias Gestta</div>
        <div class="fs-4 fw-bold text-danger">{{ cont_div.gestta }}</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
      <div class="card card-hover border-0 shadow-sm p-3 text-center">
        <div class="text-muted small">Diverg√™ncias Dom√≠nio</div>
        <div class="fs-4 fw-bold text-danger">{{ cont_div.dominio }}</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
      <div class="card card-hover border-0 shadow-sm p-3 text-center">
        <div class="text-muted small">Diverg√™ncias Web</div>
        <div class="fs-4 fw-bold text-danger">{{ cont_div.web }}</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
      <div class="card card-hover border-0 shadow-sm p-3 text-center">
        <div class="text-muted small">Diverg√™ncias VL</div>
        <div class="fs-4 fw-bold text-danger">{{ cont_div.visao }}</div>
      </div>
    </div>
  </div>


    {% if sync_last %}
    <div class="col-12">
      <div class="alert alert-secondary mt-2 shadow-sm">
        <i class="bi bi-clock-history me-2 text-warning"></i>
        <strong>√öltima atualiza√ß√£o:</strong>
        {{ sync_last.created_at|date:"d/m/Y H:i" }}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Tabela -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0 fw-semibold"><i class="bi bi-table me-2 text-warning"></i>Resultados</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Status</th>
            <th>Usu√°rio</th>
            <th>Nome Completo</th>
            <th>Usu√°rio Dom√≠nio</th>
            <th>Usu√°rio Local</th>
            <th>Departamento</th>
            <th>Email</th>
            <th class="text-center">Ponto</th>
            <th class="text-center">Gestta</th>
            <th class="text-center">Dom√≠nio</th>
            <th class="text-center">Web</th>
            <th class="text-center">Visao</th>
          </tr>
        </thead>
        <tbody>
          {% for u, v in rows %}
          <tr>
            <td>
              {% if u.status == 'Ativo' %}
                <span class="badge bg-success">Ativo</span>
              {% elif u.status == 'Inativo' %}
                <span class="badge bg-danger">Inativo</span>
              {% else %}
                <span class="badge bg-secondary">‚Äî</span>
              {% endif %}
            </td>
            <td>{{ u.nome_user }}</td>
            <td>{{ u.nome_completo }}</td>
            <td>{{ u.user_dominio }}</td>
            <td>{{ u.user_local }}</td>
            <td>{{ u.departamento_principal }}</td>
            <td>{{ u.email }}</td>

            {% for fonte in fontes %}
              {% with ok=v|dictget:fonte %}
                {% if ok.0 %}
                  <td class="text-center"><i class="bi bi-check-circle-fill text-success pulse-green"></i></td>
                {% else %}
                  <td class="text-center"><i class="bi bi-x-circle-fill text-danger pulse-red" title="{{ ok.1 }}"></i></td>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </tr>
          {% empty %}
          <tr><td colspan="10" class="text-center text-muted py-3">Nenhum registro encontrado</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

